#!/bin/bash

set -e

cp -a ${BOSH_COMPILE_TARGET}/nfs-debs/*.deb ${BOSH_INSTALL_TARGET}/

#extract all the things

pushd ${BOSH_COMPILE_TARGET}
  #ls nfs-debs/*.tar.gz | xargs -n1 tar -xzf
  ls nfs-debs/*.tar.bz2 | xargs -n1 tar -xjf
  #ls nfs-debs/*.tar.xz | xargs -n1 tar -xf
popd

# rpc-bind ( required for some nfsv3 mounts to work

#These flags are required for rpcbind and efs-utils
export C_INCLUDE_PATH="${BOSH_INSTALL_TARGET}/include:${BOSH_INSTALL_TARGET}/include/tirpc"
export CPLUS_INCLUDE_PATH="${BOSH_INSTALL_TARGET}/include:${BOSH_INSTALL_TARGET}/include/tirpc"
export CFLAGS=-L${BOSH_INSTALL_TARGET}/lib
export TIRPC_CFLAGS="-L${BOSH_INSTALL_TARGET}/lib -I${BOSH_INSTALL_TARGET}/include"
export TIRPC_LIBS="-L${BOSH_INSTALL_TARGET}/lib -I${BOSH_INSTALL_TARGET}/include"

pushd  ${BOSH_COMPILE_TARGET}/rpcbind-*/
  sed -i "/servname/s:rpcbind:sunrpc:" src/rpcbind.c
  patch -Np1 -i ${BOSH_COMPILE_TARGET}/nfs-debs/rpcbind-1.2.6-vulnerability_fixes-1.patch

  ./configure \
            --prefix=${BOSH_INSTALL_TARGET}/                                \
            --bindir=${BOSH_INSTALL_TARGET}/sbin                             \
            --with-rpcuser=root                            \
            --enable-warmstarts                            \
            --without-systemdsystemunitdir \
            LIBS="-L${BOSH_INSTALL_TARGET}/lib -ltirpc"
  make
  make install
popd